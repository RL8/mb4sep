<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment System Test - Music Besties</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .test-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }

        .test-section:last-child {
            border-bottom: none;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .control-group h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn.success {
            background: #28a745;
        }

        .btn.success:hover {
            background: #218838;
        }

        .btn.warning {
            background: #ffc107;
            color: #212529;
        }

        .btn.warning:hover {
            background: #e0a800;
        }

        .btn.danger {
            background: #dc3545;
        }

        .btn.danger:hover {
            background: #c82333;
        }

        .btn.special {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
        }

        .btn.special:hover {
            background: linear-gradient(135deg, #ff5252 0%, #ff7979 100%);
        }

        .result-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            min-height: 100px;
        }

        .result-area h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .result-content {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.success {
            background: #28a745;
        }

        .status-indicator.error {
            background: #dc3545;
        }

        .status-indicator.warning {
            background: #ffc107;
        }

        .subscription-plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .plan-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .plan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .plan-card.special {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        }

        .plan-card.lifetime {
            border-color: #4ecdc4;
            background: linear-gradient(135deg, #f0fffe 0%, #ffffff 100%);
        }

        .plan-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: #ff6b6b;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .plan-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .plan-price {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 15px;
        }

        .plan-features {
            list-style: none;
            margin: 20px 0;
        }

        .plan-features li {
            padding: 5px 0;
            color: #666;
        }

        .user-status {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .user-status h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .limit-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
        }

        .limit-warning h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            margin: 0;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .payment-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .payment-form h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .test-controls {
                grid-template-columns: 1fr;
            }
            
            .subscription-plans {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ Payment System Test</h1>
            <p>Test the complete subscription and payment system for Music Besties</p>
        </div>

        <!-- User Management Section -->
        <div class="test-section">
            <h2>üë§ User Management</h2>
            <div class="test-controls">
                <div class="control-group">
                    <h3>Current User</h3>
                    <div class="form-group">
                        <label for="userId">User ID</label>
                        <input type="text" id="userId" value="test_user_123" placeholder="Enter user ID">
                    </div>
                    <button class="btn" onclick="checkUserStatus()">Check User Status</button>
                    <button class="btn warning" onclick="resetUser()">Reset User</button>
                </div>
                
                <div class="control-group">
                    <h3>User Limits</h3>
                    <div class="form-group">
                        <label for="currentAlbums">Current Albums</label>
                        <input type="number" id="currentAlbums" value="2" min="0" max="20">
                    </div>
                    <div class="form-group">
                        <label for="currentSongs">Current Songs</label>
                        <input type="number" id="currentSongs" value="8" min="0" max="50">
                    </div>
                    <button class="btn" onclick="checkUserLimits()">Check Limits</button>
                </div>
            </div>
            
            <div class="user-status" id="userStatus">
                <h3>User Status</h3>
                <p>Click "Check User Status" to see current subscription information.</p>
            </div>
        </div>

        <!-- Subscription Plans Section -->
        <div class="test-section">
            <h2>üí≥ Subscription Plans</h2>
            <div class="test-controls">
                <div class="control-group">
                    <h3>Available Plans</h3>
                    <button class="btn" onclick="getAvailablePlans()">Get Available Plans</button>
                    <button class="btn special" onclick="getSpecialOffers()">Get Special Offers</button>
                </div>
                
                <div class="control-group">
                    <h3>Create Subscription</h3>
                    <div class="form-group">
                        <label for="planId">Plan ID</label>
                        <select id="planId">
                            <option value="monthly">Monthly Premium ($4.89/month)</option>
                            <option value="showgirl_special">Showgirl Special ($10.03/year)</option>
                            <option value="lifetime_engagement">Lifetime Engagement (FREE)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userPhone">Phone</label>
                        <input type="tel" id="userPhone" value="+1234567890" placeholder="+1234567890">
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Email</label>
                        <input type="email" id="userEmail" value="test@example.com" placeholder="test@example.com">
                    </div>
                    <button class="btn success" onclick="createSubscription()">Create Subscription</button>
                </div>
            </div>
            
            <div class="subscription-plans" id="subscriptionPlans">
                <!-- Plans will be populated here -->
            </div>
        </div>

        <!-- Feature Access Section -->
        <div class="test-section">
            <h2>üîê Feature Access Control</h2>
            <div class="test-controls">
                <div class="control-group">
                    <h3>Test Feature Access</h3>
                    <div class="form-group">
                        <label for="featureToTest">Feature</label>
                        <select id="featureToTest">
                            <option value="unlimited_albums">Unlimited Albums</option>
                            <option value="unlimited_songs">Unlimited Songs</option>
                            <option value="view_other_preferences">View Other Users' Preferences</option>
                            <option value="early_access">Early Access to Features</option>
                            <option value="community_voting">Community Voting</option>
                            <option value="basic_ranking">Basic Ranking</option>
                        </select>
                    </div>
                    <button class="btn" onclick="testFeatureAccess()">Test Access</button>
                </div>
                
                <div class="control-group">
                    <h3>Simulate User Actions</h3>
                    <button class="btn" onclick="simulateAddAlbum()">Try to Add Album</button>
                    <button class="btn" onclick="simulateAddSong()">Try to Add Song</button>
                    <button class="btn" onclick="simulateViewPreferences()">Try to View Preferences</button>
                </div>
            </div>
            
            <div class="limit-warning" id="limitWarning" style="display: none;">
                <h4>‚ö†Ô∏è Limit Reached</h4>
                <p id="limitMessage"></p>
            </div>
        </div>

        <!-- Payment Processing Section -->
        <div class="test-section">
            <h2>üí≥ Payment Processing</h2>
            <div class="test-controls">
                <div class="control-group">
                    <h3>Payment Actions</h3>
                    <button class="btn" onclick="showPaymentForm()">Show Payment Form</button>
                    <button class="btn warning" onclick="simulatePayment()">Simulate Payment</button>
                    <button class="btn" onclick="activateSubscription()">Activate Subscription</button>
                </div>
                
                <div class="control-group">
                    <h3>Subscription Management</h3>
                    <button class="btn" onclick="getSubscriptionStats()">Get Statistics</button>
                    <button class="btn danger" onclick="cancelSubscription()">Cancel Subscription</button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="test-section">
            <h2>üìä Test Results</h2>
            <div class="result-area">
                <h4>API Response</h4>
                <div class="result-content" id="testResults">Click any test button to see results here...</div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí≥ Complete Your Purchase</h3>
                <span class="close" onclick="closePaymentModal()">&times;</span>
            </div>
            <div class="payment-form">
                <h4>Payment Information</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cardNumber">Card Number</label>
                        <input type="text" id="cardNumber" value="4111111111111111" placeholder="1234 5678 9012 3456">
                    </div>
                    <div class="form-group">
                        <label for="expiryDate">Expiry Date</label>
                        <input type="text" id="expiryDate" value="12/25" placeholder="MM/YY">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cvv">CVV</label>
                        <input type="text" id="cvv" value="123" placeholder="123">
                    </div>
                    <div class="form-group">
                        <label for="cardName">Name on Card</label>
                        <input type="text" id="cardName" value="Test User" placeholder="John Doe">
                    </div>
                </div>
                <button class="btn success" onclick="processPayment()">Complete Payment</button>
            </div>
        </div>
    </div>

    <script>
        // Mock Payment System - Simulates the real MCP server
        class MockPaymentSystem {
            constructor() {
                this.users = new Map();
                this.subscriptions = new Map();
                this.specialOfferCount = 142; // 1,989 - 142 = 1,847 remaining
                this.stats = {
                    totalSubscribers: 0,
                    activeSubscriptions: 0,
                    monthlyRevenue: 0,
                    yearlyRevenue: 0
                };
            }

            getUserSubscription(userId) {
                return this.subscriptions.get(userId) || null;
            }

            getUserTier(userId) {
                const subscription = this.getUserSubscription(userId);
                if (!subscription || subscription.status !== 'active') {
                    return {
                        id: 'free',
                        name: 'Free Tier',
                        maxAlbums: 3,
                        maxSongsPerAlbum: 3,
                        maxTotalSongs: 13,
                        features: ['Basic ranking'],
                        limitations: ['Limited to 13 total songs', 'Cannot view other users']
                    };
                }
                return {
                    id: 'premium',
                    name: 'Premium Tier',
                    maxAlbums: -1,
                    maxSongsPerAlbum: -1,
                    maxTotalSongs: -1,
                    features: ['Unlimited rankings', 'View other users', 'Early access']
                };
            }

            checkUserLimits(userId, currentAlbums, currentSongs) {
                const tier = this.getUserTier(userId);
                
                if (tier.id === 'premium') {
                    return {
                        canAddAlbum: true,
                        canAddSong: true,
                        tier
                    };
                }

                const canAddAlbum = tier.maxAlbums === -1 || currentAlbums < tier.maxAlbums;
                const canAddSong = tier.maxTotalSongs === -1 || currentSongs < tier.maxTotalSongs;

                let reason = '';
                if (!canAddAlbum) {
                    reason = `You've reached the limit of ${tier.maxAlbums} albums. Upgrade to Premium for unlimited rankings!`;
                } else if (!canAddSong) {
                    reason = `You've reached the limit of ${tier.maxTotalSongs} songs. Upgrade to Premium for unlimited rankings!`;
                }

                return {
                    canAddAlbum,
                    canAddSong,
                    reason,
                    tier
                };
            }

            canUserAccessFeature(userId, feature) {
                const tier = this.getUserTier(userId);
                
                switch (feature) {
                    case 'unlimited_albums':
                    case 'unlimited_songs':
                    case 'view_other_preferences':
                    case 'early_access':
                    case 'community_voting':
                        return tier.id === 'premium';
                    case 'basic_ranking':
                        return true;
                    default:
                        return false;
                }
            }

            getAvailablePlans() {
                return [
                    {
                        id: 'monthly',
                        name: 'Monthly Premium',
                        price: 489,
                        currency: 'USD',
                        interval: 'month',
                        features: [
                            'Unlimited album rankings',
                            'Unlimited song rankings',
                            'Early access to new features',
                            'View other users\' preferences',
                            'Community voting rights'
                        ]
                    },
                    {
                        id: 'showgirl_special',
                        name: 'The Showgirl Special',
                        price: 1003,
                        currency: 'USD',
                        interval: 'year',
                        features: [
                            'Everything in Monthly Premium',
                            'Special Showgirl badge',
                            'Early access to Life of a Showgirl content',
                            'Exclusive Showgirl predictions'
                        ],
                        isSpecialOffer: true,
                        validUntil: new Date('2024-12-31')
                    },
                    {
                        id: 'lifetime_engagement',
                        name: 'The Engagement Special - Lifetime',
                        price: 0,
                        currency: 'USD',
                        interval: 'lifetime',
                        features: [
                            'Everything in Monthly Premium',
                            'Lifetime access - no recurring fees',
                            'Exclusive Engagement badge',
                            'VIP community status',
                            'Early access to all future features'
                        ],
                        isSpecialOffer: true,
                        isLimitedTime: true,
                        maxUsers: 1989
                    }
                ];
            }

            getSpecialOffers() {
                const offers = [];
                
                // Showgirl Special
                offers.push({
                    plan: {
                        id: 'showgirl_special',
                        name: 'The Showgirl Special',
                        price: 1003
                    },
                    discount: 83,
                    originalPrice: 5868,
                    savings: 4865,
                    description: 'Celebrate the upcoming Life of a Showgirl album!',
                    validUntil: new Date('2024-12-31')
                });

                // Lifetime Engagement Special
                if (this.specialOfferCount < 1989) {
                    offers.push({
                        plan: {
                            id: 'lifetime_engagement',
                            name: 'Lifetime Access',
                            price: 0
                        },
                        discount: 100,
                        originalPrice: 489,
                        savings: 489,
                        description: 'Limited time: First 1,989 users get lifetime access FREE!',
                        remainingCount: 1989 - this.specialOfferCount,
                        validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
                    });
                }

                return offers;
            }

            createSubscription(userId, planId, phone, email) {
                const plans = this.getAvailablePlans();
                const plan = plans.find(p => p.id === planId);
                
                if (!plan) {
                    return {
                        success: false,
                        message: 'Invalid subscription plan',
                        error: 'INVALID_PLAN'
                    };
                }

                if (planId === 'lifetime_engagement' && this.specialOfferCount >= 1989) {
                    return {
                        success: false,
                        message: 'Lifetime offer is sold out! Only 1,989 were available.',
                        error: 'OFFER_SOLD_OUT'
                    };
                }

                const existingSubscription = this.getUserSubscription(userId);
                if (existingSubscription && existingSubscription.status === 'active') {
                    return {
                        success: false,
                        message: 'User already has an active subscription',
                        error: 'ALREADY_SUBSCRIBED'
                    };
                }

                const subscription = {
                    id: `sub_${Date.now()}_${userId}`,
                    userId,
                    planId: plan.id,
                    plan: plan,
                    status: plan.price === 0 ? 'active' : 'pending_payment',
                    startDate: new Date(),
                    endDate: this.calculateEndDate(plan),
                    paymentSessionId: plan.price > 0 ? `session_${Date.now()}` : null,
                    createdAt: new Date()
                };

                this.subscriptions.set(userId, subscription);

                if (plan.isLimitedTime && plan.id === 'lifetime_engagement') {
                    this.specialOfferCount++;
                }

                return {
                    success: true,
                    message: 'Subscription created successfully',
                    subscription,
                    paymentUrl: plan.price > 0 ? `https://payment.example.com/session/${subscription.paymentSessionId}` : null
                };
            }

            activateSubscription(userId, paymentSessionId) {
                const subscription = this.getUserSubscription(userId);
                
                if (!subscription || subscription.paymentSessionId !== paymentSessionId) {
                    return {
                        success: false,
                        message: 'Subscription not found',
                        error: 'SUBSCRIPTION_NOT_FOUND'
                    };
                }

                subscription.status = 'active';
                subscription.activatedAt = new Date();
                this.stats.activeSubscriptions++;

                return {
                    success: true,
                    message: 'Subscription activated successfully',
                    subscription
                };
            }

            cancelSubscription(userId, reason) {
                const subscription = this.getUserSubscription(userId);
                
                if (!subscription) {
                    return {
                        success: false,
                        message: 'No active subscription found',
                        error: 'NO_SUBSCRIPTION'
                    };
                }

                subscription.status = 'cancelled';
                subscription.cancelledAt = new Date();
                subscription.cancellationReason = reason;
                this.stats.activeSubscriptions--;

                return {
                    success: true,
                    message: 'Subscription cancelled successfully',
                    subscription
                };
            }

            getSubscriptionStats() {
                return {
                    totalSubscribers: this.subscriptions.size,
                    activeSubscriptions: this.stats.activeSubscriptions,
                    lifetimeOffersRemaining: 1989 - this.specialOfferCount,
                    monthlyRevenue: this.stats.monthlyRevenue,
                    yearlyRevenue: this.stats.yearlyRevenue
                };
            }

            calculateEndDate(plan) {
                const now = new Date();
                
                switch (plan.interval) {
                    case 'month':
                        return new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
                    case 'year':
                        return new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000);
                    case 'lifetime':
                        return new Date('2099-12-31');
                    default:
                        return new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
                }
            }
        }

        // Initialize the mock payment system
        const paymentSystem = new MockPaymentSystem();

        // Test Functions
        function logResult(title, data) {
            const resultDiv = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            resultDiv.textContent = `[${timestamp}] ${title}\n${JSON.stringify(data, null, 2)}\n\n${resultDiv.textContent}`;
        }

        function checkUserStatus() {
            const userId = document.getElementById('userId').value;
            const subscription = paymentSystem.getUserSubscription(userId);
            const tier = paymentSystem.getUserTier(userId);
            
            const statusDiv = document.getElementById('userStatus');
            statusDiv.innerHTML = `
                <h3>User Status: ${userId}</h3>
                <p><strong>Tier:</strong> ${tier.name}</p>
                <p><strong>Subscription:</strong> ${subscription ? subscription.plan.name : 'None'}</p>
                <p><strong>Status:</strong> ${subscription ? subscription.status : 'Free'}</p>
                <p><strong>Features:</strong> ${tier.features.join(', ')}</p>
                ${tier.limitations ? `<p><strong>Limitations:</strong> ${tier.limitations.join(', ')}</p>` : ''}
            `;
            
            logResult('User Status Check', { subscription, tier });
        }

        function checkUserLimits() {
            const userId = document.getElementById('userId').value;
            const currentAlbums = parseInt(document.getElementById('currentAlbums').value);
            const currentSongs = parseInt(document.getElementById('currentSongs').value);
            
            const limits = paymentSystem.checkUserLimits(userId, currentAlbums, currentSongs);
            
            const warningDiv = document.getElementById('limitWarning');
            const messageDiv = document.getElementById('limitMessage');
            
            if (limits.reason) {
                warningDiv.style.display = 'block';
                messageDiv.textContent = limits.reason;
            } else {
                warningDiv.style.display = 'none';
            }
            
            logResult('User Limits Check', limits);
        }

        function getAvailablePlans() {
            const plans = paymentSystem.getAvailablePlans();
            
            const plansDiv = document.getElementById('subscriptionPlans');
            plansDiv.innerHTML = plans.map(plan => `
                <div class="plan-card ${plan.isSpecialOffer ? 'special' : ''} ${plan.id === 'lifetime_engagement' ? 'lifetime' : ''}">
                    ${plan.isSpecialOffer ? '<div class="plan-badge">SPECIAL</div>' : ''}
                    <div class="plan-name">${plan.name}</div>
                    <div class="plan-price">$${(plan.price / 100).toFixed(2)}${plan.interval === 'lifetime' ? ' (FREE)' : `/${plan.interval}`}</div>
                    <ul class="plan-features">
                        ${plan.features.map(feature => `<li>‚úÖ ${feature}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
            
            logResult('Available Plans', plans);
        }

        function getSpecialOffers() {
            const offers = paymentSystem.getSpecialOffers();
            
            logResult('Special Offers', offers);
            
            // Show offers in a more detailed way
            const plansDiv = document.getElementById('subscriptionPlans');
            plansDiv.innerHTML = offers.map(offer => `
                <div class="plan-card special ${offer.plan.id === 'lifetime_engagement' ? 'lifetime' : ''}">
                    <div class="plan-badge">LIMITED TIME</div>
                    <div class="plan-name">${offer.plan.name}</div>
                    <div class="plan-price">
                        ${offer.plan.price === 0 ? 'FREE' : `$${(offer.plan.price / 100).toFixed(2)}`}
                        <div style="font-size: 0.6em; color: #ff6b6b; margin-top: 5px;">
                            ${offer.discount}% OFF - Save $${(offer.savings / 100).toFixed(2)}
                        </div>
                    </div>
                    <p style="color: #666; margin: 15px 0;">${offer.description}</p>
                    ${offer.remainingCount ? `
                        <div style="background: #ff6b6b; color: white; padding: 10px; border-radius: 6px; margin: 15px 0;">
                            Only ${offer.remainingCount} remaining!
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function createSubscription() {
            const userId = document.getElementById('userId').value;
            const planId = document.getElementById('planId').value;
            const phone = document.getElementById('userPhone').value;
            const email = document.getElementById('userEmail').value;
            
            const result = paymentSystem.createSubscription(userId, planId, phone, email);
            
            logResult('Create Subscription', result);
            
            if (result.success) {
                alert(`Subscription created successfully!\nPlan: ${result.subscription.plan.name}\nStatus: ${result.subscription.status}`);
                checkUserStatus(); // Refresh user status
            } else {
                alert(`Subscription creation failed: ${result.message}`);
            }
        }

        function testFeatureAccess() {
            const userId = document.getElementById('userId').value;
            const feature = document.getElementById('featureToTest').value;
            
            const canAccess = paymentSystem.canUserAccessFeature(userId, feature);
            
            logResult('Feature Access Test', { feature, canAccess });
            
            alert(`Feature: ${feature}\nAccess: ${canAccess ? '‚úÖ Allowed' : '‚ùå Denied'}`);
        }

        function simulateAddAlbum() {
            const userId = document.getElementById('userId').value;
            const currentAlbums = parseInt(document.getElementById('currentAlbums').value);
            const currentSongs = parseInt(document.getElementById('currentSongs').value);
            
            const limits = paymentSystem.checkUserLimits(userId, currentAlbums, currentSongs);
            
            if (limits.canAddAlbum) {
                document.getElementById('currentAlbums').value = currentAlbums + 1;
                alert('‚úÖ Album added successfully!');
                checkUserLimits();
            } else {
                alert(`‚ùå Cannot add album: ${limits.reason}`);
            }
        }

        function simulateAddSong() {
            const userId = document.getElementById('userId').value;
            const currentAlbums = parseInt(document.getElementById('currentAlbums').value);
            const currentSongs = parseInt(document.getElementById('currentSongs').value);
            
            const limits = paymentSystem.checkUserLimits(userId, currentAlbums, currentSongs);
            
            if (limits.canAddSong) {
                document.getElementById('currentSongs').value = currentSongs + 1;
                alert('‚úÖ Song added successfully!');
                checkUserLimits();
            } else {
                alert(`‚ùå Cannot add song: ${limits.reason}`);
            }
        }

        function simulateViewPreferences() {
            const userId = document.getElementById('userId').value;
            const canAccess = paymentSystem.canUserAccessFeature(userId, 'view_other_preferences');
            
            if (canAccess) {
                alert('‚úÖ Viewing other users\' preferences...');
            } else {
                alert('‚ùå This feature requires Premium subscription. Upgrade now!');
            }
        }

        function showPaymentForm() {
            document.getElementById('paymentModal').style.display = 'block';
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
        }

        function simulatePayment() {
            const userId = document.getElementById('userId').value;
            const subscription = paymentSystem.getUserSubscription(userId);
            
            if (!subscription || subscription.status !== 'pending_payment') {
                alert('No pending payment found. Create a subscription first.');
                return;
            }
            
            const result = paymentSystem.activateSubscription(userId, subscription.paymentSessionId);
            
            logResult('Payment Simulation', result);
            
            if (result.success) {
                alert('‚úÖ Payment processed successfully! Subscription activated.');
                checkUserStatus();
                closePaymentModal();
            } else {
                alert(`‚ùå Payment failed: ${result.message}`);
            }
        }

        function processPayment() {
            // Simulate payment processing
            setTimeout(() => {
                simulatePayment();
            }, 1000);
        }

        function activateSubscription() {
            const userId = document.getElementById('userId').value;
            const subscription = paymentSystem.getUserSubscription(userId);
            
            if (!subscription) {
                alert('No subscription found. Create a subscription first.');
                return;
            }
            
            if (subscription.status === 'active') {
                alert('Subscription is already active.');
                return;
            }
            
            const result = paymentSystem.activateSubscription(userId, subscription.paymentSessionId);
            
            logResult('Activate Subscription', result);
            
            if (result.success) {
                alert('‚úÖ Subscription activated successfully!');
                checkUserStatus();
            } else {
                alert(`‚ùå Activation failed: ${result.message}`);
            }
        }

        function getSubscriptionStats() {
            const stats = paymentSystem.getSubscriptionStats();
            
            logResult('Subscription Statistics', stats);
            
            // Display stats in a nice format
            const resultDiv = document.getElementById('testResults');
            resultDiv.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${stats.totalSubscribers}</div>
                        <div class="stat-label">Total Subscribers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.activeSubscriptions}</div>
                        <div class="stat-label">Active Subscriptions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.lifetimeOffersRemaining}</div>
                        <div class="stat-label">Lifetime Offers Remaining</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">$${(stats.monthlyRevenue / 100).toFixed(2)}</div>
                        <div class="stat-label">Monthly Revenue</div>
                    </div>
                </div>
            ` + resultDiv.innerHTML;
        }

        function cancelSubscription() {
            const userId = document.getElementById('userId').value;
            const reason = prompt('Reason for cancellation (optional):');
            
            const result = paymentSystem.cancelSubscription(userId, reason);
            
            logResult('Cancel Subscription', result);
            
            if (result.success) {
                alert('‚úÖ Subscription cancelled successfully!');
                checkUserStatus();
            } else {
                alert(`‚ùå Cancellation failed: ${result.message}`);
            }
        }

        function resetUser() {
            const userId = document.getElementById('userId').value;
            paymentSystem.subscriptions.delete(userId);
            document.getElementById('currentAlbums').value = 0;
            document.getElementById('currentSongs').value = 0;
            checkUserStatus();
            alert('‚úÖ User reset to free tier');
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            checkUserStatus();
            getAvailablePlans();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('paymentModal');
            if (event.target === modal) {
                closePaymentModal();
            }
        }
    </script>
</body>
</html>
